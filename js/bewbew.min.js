(function(){var demoMode=false;var lastTimestamp="2016-01-01T00:00:00+08:00";var bufferSize=30;var esWindowSize=100;var animateRefreshTime=1;var esRefreshTime=5;var indexPattern="saas_*";var attackField="analysis";var attackDivColors={text_color:"#4ec2d1",alert_color:"#f0f6f6",ip_color:"#a4429e"};var attackColors={cybercrime:"#f26060",blocklist_de_ssh:"#33e0f1","FileIncludeAttack ":"#f98206",stopforumspam_90d:"#bee248","FileAccess ":"#16f228"};var mapColors={fill_color:"black",border_color:"#4393c3",highlight_fill_color:"gray",highlight_border_color:"rgba(250, 15, 160, 0.2)",hoverinfo_text:"#72cd3c",hoverinfo_bg:"#131a0e"};var dcLocation={lat:"39.03",lon:"117.68"};var lastFrameTime=0;var lastMapupdateTime=0;var lastEsFetchTime=0;var elasticsearchHost="http://"+window.location.host+"/elasticsearch/";var client;var asyncLock=false;function fetchES(nextStep){asyncLock=true;client.search({index:indexPattern,size:esWindowSize,body:{query:{filtered:{filter:{and:{filters:[{exists:{field:attackField}},{range:{"@timestamp":{gt:lastTimestamp,lte:"now"}}}],_cache:false}}}},sort:{"@timestamp":"desc"}}}).then(function(resp){var hits=resp.hits.hits;nextStep(hits);asyncLock=false},function(err){console.trace(err.message);asyncLock=false})}function FixedQueue(size,initialValues){initialValues=initialValues||[];var queue=Array.apply(null,initialValues);queue.fixedSize=size;queue.push=FixedQueue.push;queue.splice=FixedQueue.splice;queue.unshift=FixedQueue.unshift;FixedQueue.trimTail.call(queue);return queue}FixedQueue.trimHead=function(){if(this.length<=this.fixedSize){return}Array.prototype.splice.call(this,0,this.length-this.fixedSize)};FixedQueue.trimTail=function(){if(this.length<=this.fixedSize){return}Array.prototype.splice.call(this,this.fixedSize,this.length-this.fixedSize)};FixedQueue.wrapMethod=function(methodName,trimMethod){var wrapper=function(){var method=Array.prototype[methodName];var result=method.apply(this,arguments);trimMethod.call(this);return result};return wrapper};FixedQueue.push=FixedQueue.wrapMethod("push",FixedQueue.trimHead);FixedQueue.splice=FixedQueue.wrapMethod("splice",FixedQueue.trimTail);FixedQueue.unshift=FixedQueue.wrapMethod("unshift",FixedQueue.trimTail);var hitsBuffer,boomBuffer;var map={};function getStroke(attck){if(attck){return attackColors[attck]}if(Math.round(Math.random()*100)<70){return"blue"}else{return"red"}}var results=[];function main(){var now=Date.now(),EsDelay=(now-lastEsFetchTime)/1e3,MapDelay=(now-lastMapupdateTime)/1e3;if(!asyncLock&&EsDelay>esRefreshTime&&results.length==0){attacks.getData()}if(results.length>0&&MapDelay>animateRefreshTime){attacks.updateMap()}lastFrameTime=now;requestAnimationFrame(main)}function init(){if(!demoMode){lastTimestamp=moment().format()}client=new $.es.Client({hosts:elasticsearchHost,apiVersion:"1.7"});map=new Datamap({scope:"world",element:document.getElementById("container1"),projection:"winkel3",fills:{defaultFill:mapColors.fill_color},geographyConfig:{dataUrl:null,hideAntarctica:true,borderWidth:.75,borderColor:mapColors.border_color,popupTemplate:function(geography,data){return'<div class="hoverinfo" style="color:'+mapColors.hoverinfo_text+";background:"+mapColors.hoverinfo_bg+'">'+geography.properties.name+"</div>"},popupOnHover:true,highlightOnHover:false,highlightFillColor:mapColors.highlight_fill_color,highlightBorderColor:mapColors.highlight_border_color,highlightBorderWidth:2}});hitsBuffer=FixedQueue(bufferSize,[]);boomBuffer=FixedQueue(bufferSize,[]);lastFrameTime=Date.now();attacks.getData();main()}var attacks={updateMap:function(){var strokeColor;var result=results.shift();strokeColor=getStroke(result.intel.which_attack);hitsBuffer.push(result.hit);map.arc(hitsBuffer,{strokeWidth:2,strokeColor:strokeColor});boomBuffer.push(result.boom);map.bubbles(boomBuffer,{popupTemplate:function(geo,data){return'<div class="hoverinfo">'+data.attk+"</div>"}});var intel=result.intel;if($("#attackdiv").find(".attack_intel").length>bufferSize){$("#attackdiv").find(".attack_intel").slice(0,1).remove()}$("#attackdiv").append("<div class='attack_intel' style=color:"+attackDivColors.text_color+" >"+intel.country+" ，"+intel.region+"<span class='attack_ip' style='color:"+attackDivColors.ip_color+" '> ("+intel.ip+") </span> - "+" <span  class='attack_alert' style='color:"+attackDivColors.alert_color+"'> 攻击类型: </span> "+" <span class='attack_type' style='color:"+attackColors[intel.which_attack]+"'>  "+" "+intel.which_attack+" </span> "+"</div>");$("#attackdiv").animate({scrollTop:$("#attackdiv").prop("scrollHeight")},180);lastMapupdateTime=Date.now()},getData:function(){fetchES(function(esResults){if(lastTimestamp===esResults[0]._source["@timestamp"]){return}if(!demoMode){lastTimestamp=esResults[0]._source["@timestamp"]}var result={};esResults.forEach(function(esResult){var result={};result.hit={origin:{latitude:+esResult._source.c_ip.location.lat,longitude:+esResult._source.c_ip.location.lon},destination:{latitude:+dcLocation.lat,longitude:+dcLocation.lon}};result.boom={radius:7,latitude:+esResult._source.c_ip.location.lat,longitude:+esResult._source.c_ip.location.lon,fillOpacity:.5,attk:esResult._source.analysis};result.intel={country:esResult._source.c_ip.regionl0,region:esResult._source.c_ip.regionl1,ip:esResult._source.c_ip.ip,which_attack:esResult._source.analysis};results.push(result)})});lastFrameTime=Date.now()}};window.bewbew=function(config){if(config){demoMode=config.demoMode?config.demoMode:demoMode;lastTimestamp=config.lastTimestamp?config.lastTimestamp:lastTimestamp;bufferSize=config.bufferSize?config.bufferSize:bufferSize;esWindowSize=config.esWindowSize?config.esWindowSize:esWindowSize;animateRefreshTime=config.animateRefreshTime?config.animateRefreshTime:animateRefreshTime;esRefreshTime=config.esRefreshTime?config.esRefreshTime:esRefreshTime;indexPattern=config.indexPattern?config.indexPattern:indexPattern;attackField=config.attackField?config.attackField:attackField;attackDivColors=config.attackDivColors?config.attackDivColors:attackDivColors;attackColors=config.attackColors?config.attackColors:attackColors;mapColors=config.mapColors?config.mapColors:mapColors;dcLocation=config.dcLocation?config.dcLocation:dcLocation}$(".perfect").perfectScrollbar();$(document).ready(function(){init()});d3.select(window).on("resize",function(){location.reload()})}})();